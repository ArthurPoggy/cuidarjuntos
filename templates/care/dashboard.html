{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard ‚Ä¢ CuidarJuntos{% endblock %}

{% block content %}
<!-- FILTRO (compacto no mobile) -->
<div class="bg-white border rounded-xl p-4 sm:p-5 mb-6">
  <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">Filtrar Per√≠odo</h2>

  <form id="period-form" method="get"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 sm:gap-4 items-end">

    <!-- Data inicial -->
    <div class="lg:col-span-2">
      <label class="block text-xs sm:text-sm mb-1" for="start-date">Data Inicial</label>
      <input id="start-date" type="date" name="start"
             value="{{ filters_ui.start }}"
             class="w-full rounded-md border px-3 h-10 text-sm sm:text-base">
    </div>

    <!-- Data final -->
    <div class="lg:col-span-2">
      <label class="block text-xs sm:text-sm mb-1" for="end-date">Data Final</label>
      <input id="end-date" type="date" name="end"
             value="{{ filters_ui.end }}"
             class="w-full rounded-md border px-3 h-10 text-sm sm:text-base">
    </div>

    <!-- A√ß√µes -->
    <div class="lg:col-span-2">
      <label class="block text-xs sm:text-sm mb-1 invisible">A√ß√µes</label>
      <div class="flex items-center gap-2 w-full">
        <button type="submit"
                class="flex-1 h-10 sm:h-11 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium">
          Aplicar
        </button>

        <!-- X que remove o per√≠odo (preserva categoria, se houver) -->
        <a id="period-clear"
           href="{% url 'care:dashboard' %}?clear=1{% if filters.category %}&category={{ filters.category }}{% endif %}"
           title="Limpar filtro" aria-label="Limpar filtro"
           class="h-10 sm:h-11 aspect-square shrink-0 rounded-lg
                  bg-red-500 hover:bg-red-600 text-white
                  flex items-center justify-center">
          <svg viewBox="0 0 24 24" class="w-1/2 h-1/2" aria-hidden="true">
            <path fill="currentColor"
                  d="M18.3 5.7a1 1 0 0 0-1.4-1.4L12 9.17 7.1 4.3A1 1 0 0 0 5.7 5.7L10.6 10.6 5.7 15.5a1 1 0 1 0 1.4 1.4L12 12.03l4.9 4.87a1 1 0 0 0 1.4-1.4l-4.9-4.9 4.8-4.9Z"/>
          </svg>
        </a>
      </div>
    </div>
  </form>
</div>


<!-- CARDS DE CATEGORIA -->
<div class="mb-2 flex items-center justify-between">
  <h3 class="sr-only">Categorias</h3>
  <span class="text-xs text-gray-500 hidden sm:inline">
    Dica: clique em um card para filtrar ‚Ä¢ clique novamente para limpar
  </span>
</div>

<div id="category-cards"
     data-selected="{% if filters.category %}true{% else %}false{% endif %}"
     class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">

  {% for key, m in meta.items %}
    <button type="button"
            data-category-card
            data-category="{{ key }}"
            aria-pressed="{% if filters.category == key %}true{% else %}false{% endif %}"
            {% if filters.category == key %}data-active="1"{% endif %}
            title="Filtrar por {{ m.label }}"
            class="group w-full text-left rounded-xl border {{ m.bg }}
                   cursor-pointer transition
                   hover:shadow-md hover:-translate-y-0.5 active:scale-[.98]
                   focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400">

      <div class="flex items-center justify-between p-4">
        <div class="flex items-center gap-3">
          <span class="text-2xl">{{ m.icon }}</span>
          <div>
            <div class="font-semibold">{{ m.label }}</div>
            <div class="text-xs text-gray-500">registros</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <span class="cat-count text-2xl font-bold">{{ m.count }}</span>

          {# chip somente quando ativo #}
          {% if filters.category == key %}
            <span class="inline-flex items-center text-xs px-2 py-0.5 rounded-full bg-blue-600 text-white">
              Ativo
            </span>
          {% endif %}

          <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 transition"
               viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"/>
          </svg>
        </div>
      </div>

      <span class="sr-only">
        {% if filters.category == key %}Filtro ativo. Pressione para limpar.{% else %}Aplicar filtro de {{ m.label }}.{% endif %}
      </span>
    </button>
  {% endfor %}
</div>

<!-- CRONOGRAMA + CALEND√ÅRIO -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Cronograma -->
  <div id="schedule" class="lg:col-span-2 bg-white border rounded-xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">Cronograma de Atividades</h3>
      <div class="flex items-center gap-4 text-sm">
        <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> Realizada</span>
        <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500 inline-block"></span> Pendente</span>
        <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-rose-500 inline-block"></span> N√£o realizado</span>
      </div>
    </div>

    {% if range_mode %}
      {% if range_groups %}
        <div class="space-y-5">
          {% for g in range_groups %}
            <div>
              <div class="text-sm text-gray-500 font-medium mb-2">{{ g.date|date:"d/m/Y" }}</div>
              <div class="space-y-3">
                {% for item in g.items %}
                  {% with r=item.obj %}
                    <div data-card
                         data-date="{{ r.date|date:'Y-m-d' }}"
                         data-time="{{ r.time|time:'H:i' }}"
                         data-type="{{ r.type }}"
                         data-status="{{ item.status }}"
                         class="rounded-lg border p-3 flex items-start justify-between
                                {% if item.status == 'pending' %} bg-yellow-50
                                {% elif item.status == 'missed' %} bg-rose-50
                                {% else %} bg-green-50 {% endif %}">
                      <div class="flex items-start gap-3">
                        <div class="text-2xl">
                          {% if r.type == 'medication' %}üíä
                            {% elif r.type == 'sleep' %}üåô
                            {% elif r.type == 'meal' %}üçΩÔ∏è
                            {% elif r.type == 'bathroom' %}üöΩ
                            {% elif r.type == 'activity' %}üèÉ
                            {% elif r.type == 'vital' %}‚ù§Ô∏è
                            {% else %}üìù{% endif %}
                        </div>
                        <div>
                          <div class="font-medium">
                            {{ r.get_type_display }}{% if r.what %} - {{ r.what }}{% endif %}
                          </div>
                          <div class="text-xs text-gray-500 cj-datetime">
                              {{ r.date|date:"d/m/Y" }}{% if r.time %}, {{ r.time|time:"H:i" }}{% endif %}
                              {% if r.caregiver %} ‚Ä¢ {{ r.caregiver }}{% endif %}
                            </div>
                        </div>
                      </div>

                      <!-- Direita: Editar em cima; abaixo os bot√µes; ponto de status no fim -->
                      <div class="flex flex-col items-end gap-2 shrink-0">
                        {% if user.is_superuser or r.created_by_id == user.id %}
                          <div class="flex items-center gap-2">
                            <a href="{% url 'care:record-update' r.pk %}"
                               class="text-xs text-blue-600 hover:underline">Editar</a>
                            <button type="button"
                                    class="cj-del text-xs text-rose-600 hover:underline"
                                    data-url="{% url 'care:record-delete' r.pk %}">
                              Excluir
                            </button>
                          </div>
                        {% endif %}

                        <!-- A√ß√µes (somem se j√° n√£o estiver pendente) -->
                        <div class="cj-actions flex items-center gap-1 {% if item.status != 'pending' %}hidden{% endif %}">
                          <!-- ASCII OK -->
                          <button type="button"
                                  class="cj-mark rounded-md px-2 h-8 text-xs font-semibold bg-green-600 text-white hover:bg-green-700"
                                  data-id="{{ r.pk }}" data-status="done" title="Marcar como realizada">OK</button>
                          <!-- ASCII X -->
                          <button type="button"
                                  class="cj-mark rounded-md px-3 h-8 text-xs font-semibold bg-rose-600 text-white hover:bg-rose-700"
                                  data-id="{{ r.pk }}" data-status="missed" title="Marcar como n√£o realizado">X</button>
                        </div>

                        <span class="cj-status-dot w-3 h-3 rounded-full
                              {% if item.status == 'pending' %} bg-yellow-500
                              {% elif item.status == 'missed' %} bg-rose-500
                              {% else %} bg-green-500 {% endif %}"></span>
                      </div>
                    </div>
                    {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-gray-500">
          Sem atividades no per√≠odo selecionado
          {% if filters.start or filters.end %}
            {% if filters.start %}de {{ filters.start|date:"d/m/Y" }}{% endif %}
            {% if filters.end %} a {{ filters.end|date:"d/m/Y" }}{% endif %}
          {% endif %}.
        </div>
      {% endif %}
    {% else %}
      {% if schedule %}
        <div class="space-y-3">
          {% for item in schedule %}
            {% with r=item.obj %}
                <div data-card
                     data-date="{{ r.date|date:'Y-m-d' }}"
                     data-time="{{ r.time|time:'H:i' }}"
                     data-type="{{ r.type }}"
                     data-status="{{ item.status }}"
                     class="rounded-lg border p-3 flex items-start justify-between
                            {% if item.status == 'pending' %} bg-yellow-50
                            {% elif item.status == 'missed' %} bg-rose-50
                            {% else %} bg-green-50 {% endif %}">
                  <div class="flex items-start gap-3">
                    <div class="text-2xl">
                      {% if r.type == 'medication' %}üíä
                        {% elif r.type == 'sleep' %}üåô
                        {% elif r.type == 'meal' %}üçΩÔ∏è
                        {% elif r.type == 'bathroom' %}üöΩ
                        {% elif r.type == 'activity' %}üèÉ
                        {% elif r.type == 'vital' %}‚ù§Ô∏è
                        {% else %}üìù{% endif %}
                    </div>
                    <div>
                      <div class="font-medium">
                        {{ r.get_type_display }}{% if r.what %} - {{ r.what }}{% endif %}
                      </div>
                      <div class="text-xs text-gray-500 cj-datetime">
                          {{ r.date|date:"d/m/Y" }}{% if r.time %}, {{ r.time|time:"H:i" }}{% endif %}
                          {% if r.caregiver %} ‚Ä¢ {{ r.caregiver }}{% endif %}
                        </div>
                    </div>
                  </div>

                  <!-- Direita: Editar em cima; abaixo os bot√µes; ponto de status no fim -->
                  <div class="flex flex-col items-end gap-2 shrink-0">
                    {% if user.is_superuser or r.created_by_id == user.id %}
                      <div class="flex items-center gap-2">
                        <a href="{% url 'care:record-update' r.pk %}"
                           class="text-xs text-blue-600 hover:underline">Editar</a>
                        <button type="button"
                                class="cj-del text-xs text-rose-600 hover:underline"
                                data-url="{% url 'care:record-delete' r.pk %}">
                          Excluir
                        </button>
                      </div>
                    {% endif %}

                    <!-- A√ß√µes (somem se j√° n√£o estiver pendente) -->
                    <div class="cj-actions flex items-center gap-1 {% if item.status != 'pending' %}hidden{% endif %}">
                      <!-- ASCII OK -->
                      <button type="button"
                              class="cj-mark rounded-md px-2 h-8 text-xs font-semibold bg-green-600 text-white hover:bg-green-700"
                              data-id="{{ r.pk }}" data-status="done" title="Marcar como realizada">OK</button>
                      <!-- ASCII X -->
                      <button type="button"
                              class="cj-mark rounded-md px-3 h-8 text-xs font-semibold bg-rose-600 text-white hover:bg-rose-700"
                              data-id="{{ r.pk }}" data-status="missed" title="Marcar como n√£o realizado">X</button>
                    </div>

                    <span class="cj-status-dot w-3 h-3 rounded-full
                          {% if item.status == 'pending' %} bg-yellow-500
                          {% elif item.status == 'missed' %} bg-rose-500
                          {% else %} bg-green-500 {% endif %}"></span>
                  </div>
                </div>
                {% endwith %}
          {% endfor %}
        </div>
      {% else %}
        <div class="text-gray-500">Sem atividades para {{ schedule_day|date:"d/m/Y" }}.</div>
      {% endif %}
    {% endif %}
  </div>

  <!-- Calend√°rio + Pr√≥ximos Compromissos -->
  <div class="space-y-6">
    <!-- Calend√°rio (com popover) -->
    <div class="bg-white border rounded-xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Calend√°rio</h3>
        <div class="flex items-center gap-2">
          <button id="cj-prev" type="button" class="rounded border px-2 py-1 hover:bg-gray-50" aria-label="M√™s anterior">‚Äπ</button>
          <div id="cj-month-label" class="text-sm">{{ month_name }} {{ year }}</div>
          <button id="cj-next" type="button" class="rounded border px-2 py-1 hover:bg-gray-50" aria-label="Pr√≥ximo m√™s">‚Ä∫</button>
        </div>
      </div>

      <!-- wrapper que o JS vai re-renderizar -->
      <div id="cj-calendar">
        <table class="w-full text-center text-sm">
          <thead class="text-gray-500">
            <tr>
              <th class="py-1">Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th>
            </tr>
          </thead>
          <tbody>
            {% for week in cal_weeks %}
              <tr>
                {% for d in week %}
                  {% if d == 0 %}
                    <td class="py-1 text-gray-300"> </td>
                  {% else %}
                    <td class="py-1">
                      <a href="#"
                         data-date="{{ year }}-{{ month|stringformat:'02d' }}-{{ d|stringformat:'02d' }}"
                         class="block focus:outline-none">
                        <div class="mx-auto w-8 h-8 flex items-center justify-center rounded-full
                                    {% if d == today.day and month == today.month and year == today.year %} ring-2 ring-blue-300 {% endif %}">
                          {{ d }}
                        </div>
                        {% if d in days_with %}
                          <div class="w-1.5 h-1.5 bg-blue-500 rounded-full mx-auto mt-1"></div>
                        {% endif %}
                      </a>
                    </td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Popover e JSON -->
      <div id="cj-day-popover" class="hidden fixed z-50 w-80 max-w-[92vw] rounded-xl border bg-white shadow-xl">
        <div class="p-3 border-b flex items-center justify-between">
          <span id="cj-popover-title" class="font-medium">‚Äî</span>
          <button id="cj-popover-close" class="p-1 rounded hover:bg-gray-100" aria-label="Fechar">‚úï</button>
        </div>
        <div id="cj-popover-body" class="p-3 text-sm space-y-1"></div>
      </div>

      {% if calendar_events_by_date %}
        {{ calendar_events_by_date|json_script:"cj-cal-events" }}
      {% else %}
        <script id="cj-cal-events" type="application/json">{}</script>
      {% endif %}
    </div>

    <!-- Pr√≥ximos Compromissos (com filtro AJAX) -->
    <div class="bg-white border rounded-xl p-5" id="upcoming-card">
      <div class="flex items-center justify-between gap-3 mb-2">
        <h3 class="text-lg font-semibold">Pr√≥ximos Compromissos</h3>

        <form id="upcoming-form" class="flex items-center gap-2">
          <input
            type="date"
            name="upcoming_day"
            id="upcoming-day"
            value="{{ selected_day|default:today|date:'Y-m-d' }}"
            min="{{ today|date:'Y-m-d' }}"
            class="h-10 px-3 text-sm rounded-lg border"
            aria-label="Filtrar dia dos pr√≥ximos compromissos"
          />
          <!-- X vermelho para limpar -->
          <button
            id="upcoming-clear"
            type="button"
            class="hidden h-9 w-9 inline-flex items-center justify-center rounded-md bg-rose-600 text-white hover:bg-rose-700"
            aria-label="Limpar filtro"
            title="Limpar filtro"
          >‚úï</button>

          <span id="upcoming-loading" class="hidden text-xs text-gray-500">Carregando‚Ä¶</span>
        </form>
      </div>

      <!-- MENSAGEM logo abaixo do filtro -->
      <div id="upcoming-msg"
           class="text-sm text-gray-500 mb-3 {% if upcoming %}hidden{% endif %}">
        {% if not upcoming %}
          {% if upcoming_day %}
            Nenhum compromisso em {{ upcoming_day|date:"d/m/Y" }}.
          {% else %}
            Sem compromissos futuros registrados.
          {% endif %}
        {% endif %}
      </div>

      {% if upcoming %}
        <ul id="upcoming-list" class="space-y-3">
          {% for r in upcoming %}
            <li class="flex items-start justify-between">
              <div class="flex items-start gap-3">
                <span class="text-xl">
                  {% if r.type == 'medication' %}üíä
                    {% elif r.type == 'sleep' %}üåô
                    {% elif r.type == 'meal' %}üçΩÔ∏è
                    {% elif r.type == 'bathroom' %}üöΩ
                    {% elif r.type == 'activity' %}üèÉ
                    {% elif r.type == 'vital' %}‚ù§Ô∏è
                    {% else %}üìù{% endif %}
                </span>
                <div>
                  <div class="font-medium">
                    {{ r.get_type_display }}{% if r.what %} ‚Ä¢ {{ r.what }}{% endif %}
                  </div>
                  <div class="text-xs text-gray-500 cj-datetime">
                      {{ r.date|date:"d/m/Y" }}{% if r.time %}, {{ r.time|time:"H:i" }}{% endif %}
                      {% if r.caregiver %} ‚Ä¢ {{ r.caregiver }}{% endif %}
                    </div>
                </div>
              </div>
              <span class="w-2 h-2 rounded-full bg-yellow-500 mt-2"></span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <ul id="upcoming-list" class="space-y-3 hidden"></ul>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal Aprovar registro futuro -->
<div id="cj-approve-modal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/40" data-cj-approve-close></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-sm rounded-xl bg-white shadow-xl border">
      <div class="px-4 py-3 border-b">
        <h3 class="font-semibold">Definir data e hor√°rio</h3>
      </div>
      <div class="p-4 space-y-3">
        <p class="text-sm text-gray-600">
          Este registro est√° no futuro. Informe a <strong>data</strong> e o <strong>hor√°rio</strong> para concluir.
        </p>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs mb-1">Data</label>
            <input type="date" id="cj-approve-date" class="w-full rounded-lg border px-3 py-2">
          </div>
          <div>
            <label class="block text-xs mb-1">Hor√°rio</label>
            <input type="time" id="cj-approve-time" step="60" class="w-full rounded-lg border px-3 py-2">
          </div>
        </div>
        <p id="cj-approve-error" class="hidden text-sm text-rose-600"></p>
      </div>
      <div class="px-4 py-3 border-t flex items-center justify-end gap-2">
        <button type="button" class="px-3 py-2 rounded-lg border hover:bg-gray-50" data-cj-approve-close>Cancelar</button>
        <button type="button" id="cj-approve-confirm" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Excluir registro -->
<div id="cj-delete-modal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/40" data-cj-del-close></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-sm rounded-xl bg-white shadow-xl border">
      <div class="px-4 py-3 border-b">
        <h3 class="font-semibold">Excluir registro</h3>
      </div>
      <div class="p-4">
        <p class="text-sm">Tem certeza que deseja excluir o registro?</p>
      </div>
      <div class="px-4 py-3 border-t flex items-center justify-end gap-2">
        <button type="button" class="px-3 py-2 rounded-lg border hover:bg-gray-50" data-cj-del-close>Cancelar</button>
        <button type="button" id="cj-del-confirm" class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">
          Excluir
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Helper p/ atualizar o card ap√≥s aprova√ß√£o (usado pelo modal) -->
<script>
  // formata YYYY-MM-DD -> DD/MM/YYYY
  function cjFormatBR(iso) {
    if (!iso) return '';
    const [y, m, d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  /**
   * Atualiza data/hora exibidas e datasets do card ap√≥s salvar no backend.
   * Se a data mudar de dia, recarrega para reordenar e manter contagens coerentes.
   * @param {HTMLElement} cardEl - container do card com [data-card]
   * @param {Object} data - payload retornado pela view (ex.: { date_iso: '2025-10-10', time: '14:30' })
   */
  window.cjApplyRecordUpdate = function(cardEl, data) {
    if (!cardEl || !data) return;

    const oldIso  = cardEl.dataset.date || '';
    const newIso  = data.date_iso || oldIso;
    const newTime = data.time || (cardEl.dataset.time || '');

    // Atualiza o texto "dd/mm/yyyy, HH:MM ‚Ä¢ cuidador"
    const dtEl = cardEl.querySelector('.cj-datetime');
    if (dtEl) {
      const parts = dtEl.textContent.split('‚Ä¢');
      const who = parts[1] ? ' ‚Ä¢ ' + parts[1].trim() : '';
      dtEl.textContent = `${cjFormatBR(newIso)}${newTime ? ', ' + newTime : ''}${who}`;
    }

    // Atualiza datasets
    cardEl.dataset.date = newIso || '';
    cardEl.dataset.time = newTime || '';

    // Se mudou de dia, recarrega para recolocar o item no grupo correto
    if (oldIso && newIso && oldIso !== newIso) {
      window.location.reload();
      return;
    }

    // Mant√©m o widget ‚ÄúPr√≥ximos‚Äù sincronizado
    if (window.refreshUpcoming) window.refreshUpcoming();
  };
</script>

<script>
(function(){
  // Pega CSRF (usa o mesmo helper que voc√™ j√° tem)
  const csrftoken = (function(){
    const v = `; ${document.cookie}`;
    const p = v.split(`; csrftoken=`);
    return p.length === 2 ? p.pop().split(';').shift() : '';
  })();

  const schedule = document.getElementById('schedule');
  const modal    = document.getElementById('cj-delete-modal');
  const confirmB = document.getElementById('cj-del-confirm');

  let targetCard = null;
  let deleteUrl  = '';

  function openModal(card, url){
    targetCard = card;
    deleteUrl  = url;
    modal.classList.remove('hidden');
  }
  function closeModal(){
    modal.classList.add('hidden');
    targetCard = null;
    deleteUrl  = '';
  }

  // Ajusta o n√∫mero do card de categoria (n√£o deixa negativo)
  function adjustCatCount(type, delta){
    const el = document.querySelector(`[data-category-card][data-category="${type}"] .cat-count`);
    if (!el) return;
    const n = parseInt((el.textContent || '0').trim(), 10);
    const next = Math.max(0, (isNaN(n) ? 0 : n) + delta);
    el.textContent = next;
  }

  // Fechamento do modal
  modal?.addEventListener('click', (e)=>{
    if (e.target.hasAttribute?.('data-cj-del-close')) closeModal();
    if (e.target === modal.querySelector('.absolute.inset-0.bg-black\\/40')) closeModal();
  });

  // Abrir modal ao clicar em "Excluir" do card
  schedule?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.cj-del');
    if (!btn) return;
    const card = btn.closest('[data-card]');
    const url  = btn.dataset.url;
    openModal(card, url);
  });

  // Confirmar exclus√£o
  confirmB?.addEventListener('click', async ()=>{
    if (!targetCard || !deleteUrl) return;
    // L√™ os atributos ANTES de remover o card
    const type   = targetCard.dataset.type;        // medication, meal, etc.
    const status = targetCard.dataset.status;      // pending | done | missed

    try {
      const res = await fetch(deleteUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' }
      });
      if (!res.ok) throw new Error('HTTP');

      // Remove o card do DOM
      targetCard.remove();

      // Se a contagem da categoria considera este item, decrementa.
      // As contagens dos cards ignoram "missed", ent√£o s√≥ ajusta se n√£o for missed.
      if (type && status !== 'missed') {
        adjustCatCount(type, -1);
      }

      // Atualiza o widget ‚ÄúPr√≥ximos Compromissos‚Äù
      if (window.refreshUpcoming) window.refreshUpcoming();

      closeModal();
    } catch (err) {
      alert('N√£o foi poss√≠vel excluir. Tente novamente.');
      console.error(err);
    }
  });
})();
</script>

<script>
(function() {
  const calRoot = document.getElementById('cj-calendar');
  if (!calRoot) return;

  const CAL_API = "{% url 'care:calendar-data' %}";
  let currentYear = {{ year }};
  let currentMonth = {{ month }};
  let todayIso = "{{ today|date:'Y-m-d' }}";

  // mapa tipo -> emoji
  const TYPE_EMOJI = {
  medication:'üíä',
  sleep:'üåô',
  meal:'üçΩÔ∏è',
  bathroom:'üöΩ',
  activity:'üèÉ',
  vital:'‚ù§Ô∏è',          // üëà NOVO
  other:'üìù',
  others:'üìù'
};

  // eventos carregados (inicial do template)
  let EVENTS = {};
  const jsonEl = document.getElementById('cj-cal-events');
  if (jsonEl && jsonEl.textContent) { try { EVENTS = JSON.parse(jsonEl.textContent); } catch(e) {} }

  const pop = document.getElementById('cj-day-popover');
  const titleEl = document.getElementById('cj-popover-title');
  const bodyEl  = document.getElementById('cj-popover-body');
  const closeBtn = document.getElementById('cj-popover-close');
  const labelEl = document.getElementById('cj-month-label');
  const prevBtn = document.getElementById('cj-prev');
  const nextBtn = document.getElementById('cj-next');

  let justOpenedAt = 0;

  // helpers
  const pad2 = n => String(n).padStart(2, '0');
  const clamp = (v, min, max) => Math.max(min, Math.min(v, max));
  const isoMonth = (y, m) => `${y}-${pad2(m)}-01`;

  function formatPtBR(isoDate) {
    try {
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch { return isoDate; }
  }

  function renderItems(items) {
    if (!items || !items.length) return '<div class="text-gray-500">Sem compromissos.</div>';
    return items.map(ev => {
      const emoji = TYPE_EMOJI[ev.type] || 'üìù';
      return `
        <a href="${ev.url || '#'}" class="block p-2 rounded-lg hover:bg-gray-50">
          <div class="flex items-start gap-2">
            <span class="text-xl leading-none">${emoji}</span>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <span class="font-medium">${ev.title || 'Compromisso'}</span>
                ${ev.time ? `<span class="text-xs text-gray-500">${ev.time}</span>` : ''}
              </div>
              ${ev.who ? `<div class="text-xs text-gray-500">${ev.who}</div>` : ''}
            </div>
          </div>
        </a>
      `;
    }).join('');
  }

  function renderCalendarTable(data) {
    const weeks = data.weeks;
    const daysWith = new Set(data.days_with || []);
    const [ty, tm, td] = (data.today_iso || todayIso).split('-').map(Number);

    let html = `
      <table class="w-full text-center text-sm">
        <thead class="text-gray-500">
          <tr><th class="py-1">Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr>
        </thead>
        <tbody>
    `;
    for (const week of weeks) {
      html += '<tr>';
      for (const d of week) {
        if (d === 0) {
          html += `<td class="py-1 text-gray-300"> </td>`;
        } else {
          const iso = `${data.year}-${pad2(data.month)}-${pad2(d)}`;
          const isToday = (data.year === ty && data.month === tm && d === td);
          html += `
            <td class="py-1">
              <a href="#" data-date="${iso}" class="block focus:outline-none">
                <div class="mx-auto w-8 h-8 flex items-center justify-center rounded-full ${isToday ? ' ring-2 ring-blue-300' : ''}">
                  ${d}
                </div>
                ${daysWith.has(d) ? '<div class="w-1.5 h-1.5 bg-blue-500 rounded-full mx-auto mt-1"></div>' : ''}
              </a>
            </td>`;
        }
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  function openPopover(dateISO, anchorEl) {
    const items = EVENTS[dateISO] || [];
    titleEl.textContent = formatPtBR(dateISO);
    bodyEl.innerHTML = renderItems(items);

    // limite ~3 itens (scroll se houver mais)
    if (items.length > 3) bodyEl.classList.add('max-h-56','overflow-y-auto');
    else bodyEl.classList.remove('max-h-56','overflow-y-auto');

    // prepara para medir e posicionar (elemento √© fixed)
    pop.classList.remove('hidden');
    pop.style.visibility = 'hidden';

    const r = anchorEl.getBoundingClientRect();
    const pw = pop.offsetWidth;
    const ph = pop.offsetHeight;

    let left = r.left;             // base no viewport
    let top  = r.bottom + 8;       // por padr√£o, abaixo do dia

    // se estourar embaixo, coloca acima
    if (top + ph + 8 > window.innerHeight) top = r.top - ph - 8;

    // clamp para n√£o sair da viewport
    left = clamp(left, 8, window.innerWidth  - pw - 8);
    top  = clamp(top,  8, window.innerHeight - ph - 8);

    // como √© position: fixed, N√ÉO somamos scrollX/scrollY
    pop.style.left = left + 'px';
    pop.style.top  = top  + 'px';
    pop.style.visibility = 'visible';

    justOpenedAt = Date.now();
  }

  function closePopover() { pop.classList.add('hidden'); }

  // navega√ß√£o de m√™s (AJAX/Fetch)
  async function loadMonth(iso) {
    try {
      const res = await fetch(`${CAL_API}?m=${encodeURIComponent(iso)}`, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return;
      const data = await res.json();
      cjApplyRecordUpdate(card, data);

      currentYear = data.year;
      currentMonth = data.month;
      todayIso = data.today_iso || todayIso;
      EVENTS = data.events_by_date || {}

      if (labelEl) labelEl.textContent = `${data.month_name} ${data.year}`;
      calRoot.innerHTML = renderCalendarTable(data);
      closePopover();
    } catch (e) {
      console.error('calendar load error', e);
    }
  }

  prevBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const d = new Date(`${currentYear}-${pad2(currentMonth)}-01T00:00:00`);
    d.setMonth(d.getMonth() - 1);
    loadMonth(`${d.getFullYear()}-${pad2(d.getMonth()+1)}-01`);
  });

  nextBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const d = new Date(`${currentYear}-${pad2(currentMonth)}-01T00:00:00`);
    d.setMonth(d.getMonth() + 1);
    loadMonth(`${d.getFullYear()}-${pad2(d.getMonth()+1)}-01`);
  });

  // Clique no dia (delega√ß√£o)
  calRoot.addEventListener('click', (e) => {
    const link = e.target.closest('a[data-date]');
    if (!link) return;
    const dateISO = link.getAttribute('data-date');
    if (!dateISO) return;
    e.preventDefault();
    e.stopPropagation();
    openPopover(dateISO, link);
  });

  // Acessibilidade
  calRoot.addEventListener('keydown', (e) => {
    const link = e.target.closest('a[data-date]');
    if (!link) return;
    if (e.key === 'Enter' || e.key === ' ') {
      const dateISO = link.getAttribute('data-date');
      if (!dateISO) return;
      e.preventDefault();
      e.stopPropagation();
      openPopover(dateISO, link);
    }
  });

  // Evita que o mousedown feche o popover
  pop.addEventListener('click', (e) => e.stopPropagation());

  // Clique fora ‚Äî toler√¢ncia maior para n√£o fechar ao abrir
  document.addEventListener('click', (e) => {
    if (pop.classList.contains('hidden')) return;
    if (Date.now() - justOpenedAt < 200) return;        // 200ms
    if (e.target.closest('#cj-day-popover')) return;     // clique dentro
    closePopover();
  });

  // Bot√£o fechar + Esc
  closeBtn.addEventListener('click', closePopover);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePopover(); });
})();
</script>

<script>
(function(){
  const UPC_API = "{% url 'care:upcoming-data' %}";
  const TYPE_EMOJI = { medication:'üíä', sleep:'üåô', meal:'üçΩÔ∏è', bathroom:'üöΩ', activity:'üèÉ', other:'üìù', others:'üìù' };
  // üîé categoria atual (vinda do filtro do topo)
  const CURRENT_CATEGORY = "{{ filters.category|default_if_none:'' }}";

  const form   = document.getElementById('upcoming-form');
  if (!form) return;

  const dayInp = document.getElementById('upcoming-day');
  const clear  = document.getElementById('upcoming-clear');
  const list   = document.getElementById('upcoming-list');
  const msg    = document.getElementById('upcoming-msg');
  const loadEl = document.getElementById('upcoming-loading');

  // hoje em ISO (YYYY-MM-DD) e boundary do input
  const todayISO = "{{ today|date:'Y-m-d' }}";
  if (dayInp) {
    dayInp.setAttribute('min', todayISO);
    // se vier vazio, default = hoje; se vier passado, corrige para hoje
    if (!dayInp.value || dayInp.value < todayISO) dayInp.value = todayISO;
  }

  function setLoading(v){ loadEl.classList.toggle('hidden', !v); }
  function toggleClear(){ clear.classList.toggle('hidden', !dayInp.value); }

  function render(items, dayISO){
    if (!items || !items.length) {
      list.classList.add('hidden');
      msg.classList.remove('hidden');
      if (dayISO) {
        const [y,m,d] = dayISO.split('-');
        msg.textContent = `Nenhum compromisso em ${d}/${m}/${y}.`;
      } else {
        msg.textContent = 'Sem compromissos futuros registrados.';
      }
      list.innerHTML = '';
      return;
    }
    msg.classList.add('hidden');
    list.classList.remove('hidden');
    list.innerHTML = items.map(ev => {
      const emoji = TYPE_EMOJI[ev.type] || 'üìù';
      const who   = ev.who ? ` ‚Ä¢ ${ev.who}` : '';
      const time  = ev.time ? ` ${ev.time}` : '';
      return `
        <li class="flex items-start justify-between">
          <div class="flex items-start gap-3">
            <span class="text-xl">${emoji}</span>
            <div>
              <div class="font-medium">${ev.title || 'Compromisso'}</div>
              <div class="text-xs text-gray-500">${ev.date}${time}${who}</div>
            </div>
          </div>
          <span class="w-2 h-2 rounded-full bg-yellow-500 mt-2"></span>
        </li>`;
    }).join('');
  }

  async function loadUpcoming(dayISO){
  try {
    setLoading(true);
    const params = new URLSearchParams();
    if (dayISO) params.set('day', dayISO);
    if (CURRENT_CATEGORY) params.set('category', CURRENT_CATEGORY);
    params.set('limit', '50'); // <- pega at√© 50 futuros
    const url = `${UPC_API}?${params.toString()}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('http');
    const data = await res.json();
    render((data && data.items) || [], dayISO);
  } catch(e) {
    console.error(e);
  } finally {
    setLoading(false);
  }
}

  // üîÑ exp√µe fun√ß√£o global para outras partes da p√°gina (p.ex. cronograma)
  window.refreshUpcoming = function(){
    loadUpcoming(dayInp && dayInp.value ? dayInp.value : '');
  };

  form.addEventListener('submit', (e) => e.preventDefault());

  // Filtra automaticamente e impede datas anteriores a hoje
  dayInp.addEventListener('change', () => {
    let v = dayInp.value;
    if (v && v < todayISO) {           // compara√ß√£o string funciona em YYYY-MM-DD
      dayInp.value = todayISO;
      v = todayISO;
    }
    toggleClear();
    loadUpcoming(v || '');
  });

  clear.addEventListener('click', () => {
    dayInp.value = '';
    toggleClear();
    loadUpcoming('');
  });

  // estado inicial: bot√£o limpar e LISTA do DIA ATUAL
  toggleClear();
  loadUpcoming(dayInp && dayInp.value ? dayInp.value : '');
})();
</script>

<script>
// CSRF via cookie
function getCookie(name){
  const v = `; ${document.cookie}`;
  const p = v.split(`; ${name}=`);
  if (p.length === 2) return p.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');

(function(){
  const wrap = document.getElementById('schedule');
  if (!wrap) return;

  // ---- Modal refs
  const modal     = document.getElementById('cj-approve-modal');
  const mDate     = document.getElementById('cj-approve-date');
  const mTime     = document.getElementById('cj-approve-time');
  const mError    = document.getElementById('cj-approve-error');
  const mConfirm  = document.getElementById('cj-approve-confirm');

  function pad2(n){ return String(n).padStart(2,'0'); }
  function nowLocalParts(){
    const d = new Date();
    return {
      dateISO: `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`,
      timeHM : `${pad2(d.getHours())}:${pad2(d.getMinutes())}`
    };
  }

  function isFuture(dateISO, timeHM){
    const {dateISO: today, timeHM: nowHM} = nowLocalParts();
    if (!dateISO) return false;
    if (dateISO > today) return true;
    if (dateISO < today) return false;
    // mesmo dia
    if (!timeHM) return false;     // sem hora -> tratamos como presente
    return timeHM > nowHM;
  }

  function openModal(defaultDate, defaultTime){
    const {dateISO, timeHM} = nowLocalParts();
    mDate.value = defaultDate || dateISO;
    mTime.value = defaultTime || timeHM;
    mError.classList.add('hidden');
    modal.classList.remove('hidden');
  }
  function closeModal(){
    modal.classList.add('hidden');
    mError.classList.add('hidden');
    mConfirm.removeAttribute('data-id');
  }

  // fechar modal (overlay e bot√µes com data-cj-approve-close)
  modal?.addEventListener('click', (e)=>{
    if (e.target.hasAttribute?.('data-cj-approve-close')) closeModal();
    if (e.target === modal.querySelector('.absolute.inset-0.bg-black\\/40')) closeModal();
  });

  // ------- Clique OK / X nos cards
  wrap.addEventListener('click', async (e) => {
    const btn = e.target.closest('.cj-mark');
    if (!btn) return;

    const id = btn.dataset.id;
    const nextStatus = btn.dataset.status; // 'done' ou 'missed'
    const url = "{% url 'care:record-set-status' 0 %}".replace('/0/', `/${id}/`);

    const card    = btn.closest('[data-card]');
    const dot     = card.querySelector('.cj-status-dot');
    const actions = card.querySelector('.cj-actions');
    const marks   = actions ? actions.querySelectorAll('.cj-mark') : [];

    // l√™ data/hora atuais do card para decidir futuro/presente
    const cardDate = card.dataset.date || '';
    const cardTime = card.dataset.time || '';

    // ---- Caso especial: tentar "OK" em registro futuro -> abre modal
    if (nextStatus === 'done' && isFuture(cardDate, cardTime)) {
      // armazena no bot√£o confirmar qual registro estamos editando
      mConfirm.dataset.id = id;
      // sugere valores: hoje + agora
      openModal();
      // quando confirmar, dispara o POST com date/time
      mConfirm.onclick = async () => {
        const dISO = (mDate.value || '').trim();
        const tHM  = (mTime.value || '').trim();
        // valida√ß√µes
        if (!dISO || !tHM) {
          mError.textContent = 'Informe data e hor√°rio.';
          mError.classList.remove('hidden');
          return;
        }
        if (isFuture(dISO, tHM)) {
          mError.textContent = 'Para concluir, use uma data/hor√°rio que n√£o sejam futuros.';
          mError.classList.remove('hidden');
          return;
        }

        try {
          marks.forEach(b => b.disabled = true);
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
            body: new URLSearchParams({ status: 'done', date: dISO, time: tHM })
          });
          if (!res.ok) throw new Error('HTTP');
          const data = await res.json();

          // atualiza cor do card
          card.classList.remove('bg-yellow-50','bg-rose-50');
          card.classList.add('bg-green-50');
          dot.classList.remove('bg-yellow-500','bg-rose-500');
          dot.classList.add('bg-green-500');
          // esconde a√ß√µes
          if (actions) {
            actions.classList.add('hidden');
            actions.setAttribute('aria-hidden', 'true');
          }

          // atualiza texto/data-* do card (e recarrega se mudou de dia)
          if (window.cjApplyRecordUpdate) {
            window.cjApplyRecordUpdate(card, data);
          } else {
            // fallback m√≠nimo
            card.dataset.date = data.date_iso || card.dataset.date;
            card.dataset.time = data.time || card.dataset.time;
            if (window.refreshUpcoming) window.refreshUpcoming();
          }

          closeModal();
        } catch (err) {
          console.error(err);
          mError.textContent = 'N√£o foi poss√≠vel concluir. Tente novamente.';
          mError.classList.remove('hidden');
        } finally {
          marks.forEach(b => b.disabled = false);
        }
      };

      return; // n√£o segue o fluxo padr√£o
    }

    // ---- Fluxo padr√£o (X ou OK em passado/presente)
    try {
      marks.forEach(b => b.disabled = true);

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
        body: new URLSearchParams({ status: nextStatus })
      });
      if (!res.ok) throw new Error('HTTP');

      const data = await res.json();

      // atualiza classes
      card.classList.remove('bg-yellow-50','bg-green-50','bg-rose-50');
      dot.classList.remove('bg-yellow-500','bg-green-500','bg-rose-500');
      if (data.status === 'done') {
        card.classList.add('bg-green-50');  dot.classList.add('bg-green-500');
      } else if (data.status === 'missed') {
        card.classList.add('bg-rose-50');   dot.classList.add('bg-rose-500');
      } else {
        card.classList.add('bg-yellow-50'); dot.classList.add('bg-yellow-500');
      }

      if (actions) {
        actions.classList.add('hidden');
        actions.setAttribute('aria-hidden', 'true');
      }

      // se o backend devolver data/hora atualizadas (ex.: marca√ß√£o ‚Äúdone‚Äù com ajuste),
      // reflete no card tamb√©m
      if (window.cjApplyRecordUpdate) window.cjApplyRecordUpdate(card, data);
      if (window.refreshUpcoming) window.refreshUpcoming();

    } catch (err) {
      alert('N√£o foi poss√≠vel atualizar o status. Tente novamente.');
      console.error(err);
      marks.forEach(b => b.disabled = false);
    }
  });
})();
</script>

<!-- ‚úÖ Script √öNICO para o filtro de per√≠odo (consolida os dois antigos) -->
<script>
(function () {
  const form  = document.getElementById('period-form');
  if (!form) return;

  const start = document.getElementById('start-date');
  const end   = document.getElementById('end-date');
  const clear = document.getElementById('period-clear');
  const ERR_MSG = 'A data final n√£o pode ser anterior √† data inicial.';

  function toggleClear() {
    if (!clear) return;
    clear.classList.toggle('hidden', !(start.value || end.value));
  }

  function validate() {
    if (start.value && end.value && end.value < start.value) {
      end.setCustomValidity(ERR_MSG);
    } else {
      end.setCustomValidity('');
    }
  }

  function syncEndMin() {
    if (start.value) {
      end.min = start.value;
      if (end.value && end.value < start.value) end.value = '';
    } else {
      end.removeAttribute('min');
    }
    validate();
    toggleClear();
  }

  // eventos
  start.addEventListener('input',  syncEndMin);
  start.addEventListener('change', syncEndMin);
  end  .addEventListener('input',  validate);
  end  .addEventListener('change', validate);

  form.addEventListener('submit', (e) => {
    validate();
    if (!form.checkValidity()) {
      e.preventDefault();
      end.reportValidity();
    }
  });

  // bot√£o limpar: deixa o <a> navegar; s√≥ limpa visual antes
  clear?.addEventListener('click', () => {
    start.value = '';
    end.value   = '';
    // navega√ß√£o ocorre pelo href do <a id="period-clear">
  });

  // estado inicial
  syncEndMin();
})();
</script>

<script>
(function () {
  const cards = document.querySelectorAll('[data-category-card]');
  if (!cards.length) return;

  // URL base do dashboard (sem querystring)
  const baseUrl = "{% url 'care:dashboard' %}";

  // Inputs do filtro principal (usamos os valores atuais deles)
  const startEl = document.getElementById('start-date');
  const endEl   = document.getElementById('end-date');

  function toggleCategory(cat){
    const current = new URL(window.location.href);
    const currentCat = current.searchParams.get('category');

    // sempre partimos da URL limpa, mas preservando o per√≠odo atual
    const url = new URL(baseUrl, window.location.origin);

    const startVal = (startEl && startEl.value || '').trim();
    const endVal   = (endEl   && endEl.value   || '').trim();

    // Se o usu√°rio preencheu datas no filtro principal, aplicamos junto
    if (startVal) url.searchParams.set('start', startVal);
    if (endVal)   url.searchParams.set('end',   endVal);

    // Se n√£o h√° datas e a URL atual tem clear=1, preserva para N√ÉO voltar ao "hoje"
    if (!startVal && !endVal && current.searchParams.get('clear') === '1') {
      url.searchParams.set('clear', '1');
    }

    // Liga/desliga a categoria, preservando o per√≠odo montado acima
    if (currentCat && currentCat === cat) {
      // clicou na mesma categoria -> remove s√≥ a categoria
      // (mant√©m start/end/clear)
    } else {
      url.searchParams.set('category', cat);
    }

    url.hash = '';
    window.location.assign(url.toString());
  }

  cards.forEach(card => {
    const cat = card.dataset.category;
    if (!cat) return;
    card.addEventListener('click', () => toggleCategory(cat));
    card.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCategory(cat); }
    });
  });
})();
</script>

{% endblock content %}