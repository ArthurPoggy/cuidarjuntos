{% extends "base.html" %}
{% load static %}
{% block title %}Novo Registro ‚Ä¢ CuidarJuntos{% endblock %}

{% block content %}
<!-- Grade de categorias -->
<div class="bg-white border rounded-xl p-5 mb-6">
  <h2 class="text-xl font-semibold mb-4">Selecione a Categoria</h2>

  {% url 'care:record-create' as new_url %}
  <ul class="grid grid-cols-2 gap-3 sm:grid-cols-3 sm:gap-4">
    {% for value,label in categories %}
      <li>
        <a href="{{ new_url }}?category={{ value }}"
           class="group block rounded-xl border bg-white focus:outline-none focus:ring-2 focus:ring-blue-300
                  p-3 sm:p-4 h-28 sm:h-32 flex flex-col items-center justify-center select-none touch-manipulation
                  {% if selected_category == value %} ring-2 ring-blue-500 bg-blue-50 border-blue-200 {% else %} hover:shadow-sm {% endif %}">
          <span class="text-3xl sm:text-4xl mb-1">
            {% if value == 'medication' %}üíä{% elif value == 'sleep' %}üåô
            {% elif value == 'meal' %}üçΩÔ∏è{% elif value == 'bathroom' %}üöΩ
            {% elif value == 'activity' %}üèÉ{% elif value == 'vital' %}‚ù§Ô∏è
            {% elif value == 'progress' %}üìà{% else %}‚ûï{% endif %}
          </span>
          <span class="text-sm sm:text-base font-medium text-center leading-tight">{{ label }}</span>
        </a>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Formul√°rio -->
<div class="bg-white border rounded-xl p-5">
  <h3 class="text-lg font-semibold mb-2">
    Registrar {% for v,l in categories %}{% if v == selected_category %}{{ l }}{% endif %}{% endfor %}
  </h3>

  {% if current_patient %}
    <p class="text-sm text-gray-600 mb-4">Paciente: <strong>{{ current_patient.name }}</strong></p>
  {% endif %}

  {% if form.errors %}
    <div class="mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-red-700 text-sm">
      <strong>Corrija os erros abaixo:</strong>
      {{ form.errors }}
    </div>
  {% endif %}

  <form method="post" class="space-y-4" id="record-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Campos ocultos (travados) -->
    <div class="hidden">
      {{ form.patient }}
      {{ form.type }}
    </div>

    <!-- Data / Hora -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1">Data</label>
        {{ form.date }}
        {{ form.date.errors }}
      </div>
      <div>
        <label class="block text-sm mb-1">Hor√°rio</label>
        {{ form.time }}
        {{ form.time.errors }}
      </div>
    </div>

    <!-- Recorr√™ncia -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-xs sm:text-sm mb-1">Recorr√™ncia</label>
        {% if form.recurrence %} {{ form.recurrence }} {{ form.recurrence.errors }}
        {% else %}
          <select name="recurrence" id="recurrence" class="w-full rounded-md border px-3 h-10">
            <option value="none">N√£o se repete</option>
            <option value="daily">Diariamente</option>
            <option value="weekly">Semanalmente</option>
            <option value="monthly">Mensalmente</option>
          </select>
        {% endif %}
        <p class="mt-1 text-xs text-gray-500">Quando ativada, cria uma s√©rie at√© a data final.</p>
      </div>

      <div id="repeat-until-wrap" class="hidden">
        <label class="block text-xs sm:text-sm mb-1">Repetir at√©</label>
        {% if form.repeat_until %} {{ form.repeat_until }} {{ form.repeat_until.errors }}
        {% else %}
          <input type="date" name="repeat_until" id="repeat_until" class="w-full rounded-md border px-3 h-10">
        {% endif %}
        <p class="mt-1 text-xs text-gray-500">N√£o pode ser anterior √† Data.</p>
      </div>
    </div>

{% if form.show_medication_fields %}
  <div class="mt-2 space-y-3">
    <div>
      <label class="block text-sm mb-2">Medicamento/Dose</label>
      {{ form.medication.errors }}
      <div class="flex flex-wrap gap-3">
        {% for rb in form.medication %}
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label }}</span>
          </label>
        {% empty %}
          <span class="text-sm text-gray-500">Nenhum rem√©dio cadastrado.</span>
        {% endfor %}
      </div>
      <div class="mt-2 hidden" data-other-for="medication">
        <label class="block text-sm mb-1">Outro medicamento/dose</label>
        {{ form.medication_other }}
        {{ form.medication_other.errors }}
      </div>
      <p class="text-xs text-gray-500 mt-2">
        N√£o encontrou? <a href="{% url 'care:medication-stock' %}" class="text-blue-600 hover:underline">Cadastre no estoque</a>
      </p>
      <div class="hidden">{{ form.what }}</div>
    </div>
    <div>
      <label class="block text-sm mb-1">Quantidade de c√°psulas/gotas</label>
      {{ form.capsule_quantity }}
      {{ form.capsule_quantity.errors }}
    </div>
  </div>
{% elif form.show_vital_fields %}
  <div class="mt-2 space-y-3">
    <div>
      <label class="block text-sm mb-2">Qual</label>
      {{ form.vital_kind.errors }}
      <div class="flex flex-wrap gap-3">
        {% for rb in form.vital_kind %}
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="mt-2 hidden" data-other-for="vital_kind">
        <label class="block text-sm mb-1">Outro</label>
        {{ form.vital_kind_other }}
        {{ form.vital_kind_other.errors }}
      </div>
      <div class="hidden">{{ form.what }}</div>
    </div>
    <div>
      <label class="block text-sm mb-2">Status</label>
      {{ form.vital_status.errors }}
      <div class="flex flex-wrap gap-3">
        {% for rb in form.vital_status %}
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="mt-2 hidden" data-other-for="vital_status">
        <label class="block text-sm mb-1">Outro</label>
        {{ form.vital_status_other }}
        {{ form.vital_status_other.errors }}
      </div>
    </div>
  </div>
{% elif form.show_bathroom_fields %}
  <div class="mt-2 space-y-3">
    <div>
      <label class="block text-sm mb-2">Tipo</label>
      {{ form.bathroom_type.errors }}
      <div class="flex flex-wrap gap-3">
        {% for rb in form.bathroom_type %}
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="mt-2 hidden" data-other-for="bathroom_type">
        <label class="block text-sm mb-1">Outro</label>
        {{ form.bathroom_type_other }}
        {{ form.bathroom_type_other.errors }}
      </div>
      <div class="hidden">{{ form.what }}</div>
    </div>
    <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50 w-fit">
      {{ form.bathroom_no_occurrence }}
      <span>Sem ocorr√™ncia durante o dia</span>
    </label>
  </div>
{% elif form.show_meal_fields %}
  <div class="mt-2 space-y-3">
    <div>
      <label class="block text-sm mb-2">Refei√ß√£o</label>
      {{ form.meal_type.errors }}
      <div class="flex flex-wrap gap-3">
        {% for rb in form.meal_type %}
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="mt-2 hidden" data-other-for="meal_type">
        <label class="block text-sm mb-1">Outro</label>
        {{ form.meal_type_other }}
        {{ form.meal_type_other.errors }}
      </div>
      <div class="hidden">{{ form.what }}</div>
    </div>
    <div>
      <label class="block text-sm mb-2">Aceita√ß√£o</label>
      {{ form.meal_acceptance.errors }}
      <div class="flex flex-wrap gap-3">
        {% for rb in form.meal_acceptance %}
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="mt-2 hidden" data-other-for="meal_acceptance">
        <label class="block text-sm mb-1">Outro</label>
        {{ form.meal_acceptance_other }}
        {{ form.meal_acceptance_other.errors }}
      </div>
    </div>
  </div>
{% elif form.show_sleep_event %}
  <div class="mt-2">
    <label class="block text-sm mb-2">Status do sono</label>
    {{ form.sleep_event.errors }}
    <ul class="flex gap-3">
      {% for rb in form.sleep_event %}
        <li>
          <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
            {{ rb.tag }} <span>{{ rb.choice_label|title }}</span>
          </label>
        </li>
      {% endfor %}
    </ul>
    <div class="mt-2 hidden" data-other-for="sleep_event">
      <label class="block text-sm mb-1">Outro</label>
      {{ form.sleep_event_other }}
      {{ form.sleep_event_other.errors }}
    </div>
  </div>
{% elif form.show_progress_trend %}
  <div class="mt-2">
    <label class="block text-sm mb-2">Classifique como:</label>
    {{ form.progress_trend.errors }}
    <div class="flex flex-wrap gap-3">
      {% with selected=form.progress_trend.value %}
        {% for value,label in form.progress_trend.field.choices %}
          {% if value %}
            <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
              <input type="radio"
                     name="{{ form.progress_trend.name }}"
                     value="{{ value }}"
                     {% if selected == value %}checked{% endif %}>
              <span>{{ label|title }}</span>
            </label>
          {% endif %}
        {% endfor %}
      {% endwith %}
    </div>
    <div class="mt-2 hidden" data-other-for="progress_trend">
      <label class="block text-sm mb-1">Outro</label>
      {{ form.progress_trend_other }}
      {{ form.progress_trend_other.errors }}
    </div>
    <div class="hidden">{{ form.what }}</div>
  </div>
{% else %}
  <!-- Outras categorias: "O que" -->
  <div class="mt-2">
        <label class="block text-sm mb-1">
          {% if selected_category == 'medication' %}Medicamento/Dose
          {% elif selected_category == 'meal' %}Refei√ß√£o
          {% elif selected_category == 'sleep' %}Per√≠odo/Qualidade
          {% elif selected_category == 'bathroom' %}Tipo (Urina/Evacua√ß√£o)
          {% elif selected_category == 'activity' %}Atividade
          {% elif selected_category == 'vital' %}Sinal (PA, glicemia, temperatura‚Ä¶)
          {% else %}Tipo / Detalhe{% endif %}
        </label>
        {{ form.what }}
        {{ form.what.errors }}
  </div>
{% endif %}

{% with cat=selected_category %}
  <div class="mt-4 rounded-lg border bg-gray-50 p-3" data-voice-block data-voice-category="{{ cat }}">
    <div class="flex flex-wrap items-center gap-2">
      <button type="button"
              class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm bg-white hover:bg-gray-50"
              data-voice-btn>
        <span aria-hidden="true">üéôÔ∏è</span> Falar
      </button>
      <button type="button"
              class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm bg-white hover:bg-gray-50"
              data-voice-apply>
        Aplicar texto
      </button>
      <span class="text-xs text-gray-500" data-voice-status></span>
    </div>
    <textarea rows="2"
              class="mt-2 w-full rounded-lg border px-3 py-2 text-sm"
              data-voice-transcript
              placeholder="{% if cat == 'sleep' %}Ex.: Dormiu hoje √†s 22:30. Observa√ß√µes: acordou 2x.{% elif cat == 'medication' %}Ex.: Dipirona 500mg, 2 c√°psulas hoje √†s 21:00. Observa√ß√µes: dor diminuiu.{% elif cat == 'vital' %}Ex.: Press√£o arterial, hipertenso, hoje √†s 09:00.{% elif cat == 'bathroom' %}Ex.: Urina hoje √†s 08:00. Observa√ß√µes: sem dor.{% elif cat == 'meal' %}Ex.: Almo√ßo, boa aceita√ß√£o, hoje √†s 12:30.{% elif cat == 'activity' %}Ex.: Caminhada leve hoje √†s 09:00. Observa√ß√µes: 15 minutos.{% elif cat == 'progress' %}Ex.: Evolu√ß√£o hoje √†s 10:00. Observa√ß√µes: mais disposi√ß√£o.{% elif cat == 'other' %}Ex.: Troca de curativo hoje √†s 15:00. Observa√ß√µes: sem sangramento.{% else %}Descreva o registro e hor√°rio.{% endif %}"
              aria-label="Transcri√ß√£o do √°udio"></textarea>
    <p class="mt-1 text-xs text-gray-500">
      A transcri√ß√£o tenta preencher data, hor√°rio, recorr√™ncia e campos espec√≠ficos da categoria.
    </p>
  </div>
{% endwith %}

    <!-- Observa√ß√µes -->
    <div>
      <label class="block text-sm mb-1">Observa√ß√µes</label>
      {{ form.description }}
      {{ form.description.errors }}
    </div>

    <div class="flex items-center gap-2 pt-1">
      {{ form.is_exception }}
      <label for="{{ form.is_exception.id_for_label }}" class="text-sm">Marcar como exce√ß√£o</label>
    </div>
    {{ form.is_exception.errors }}

    <button class="w-full bg-blue-600 text-white rounded-lg py-3 font-medium hover:bg-blue-700">
      Registrar Atividade
    </button>
  </form>
</div>

<div id="history" class="bg-white border rounded-xl p-5 mt-6">
  <h2 class="text-xl font-semibold mb-4">Hist√≥rico recente</h2>
  {% if recent and recent.paginator.count %}
    <ol class="divide-y">
      {% for r in recent %}
        <li class="py-3 flex items-start justify-between gap-6">
          <div class="flex items-start gap-3">
            <span class="text-2xl">
              {% if r.type == 'medication' %}üíä{% elif r.type == 'sleep' %}üåô
              {% elif r.type == 'meal' %}üçΩÔ∏è{% elif r.type == 'bathroom' %}üöΩ
              {% elif r.type == 'activity' %}üèÉ{% elif r.type == 'vital' %}‚ù§Ô∏è
              {% elif r.type == 'progress' %}üìà{% else %}üìù{% endif %}
            </span>
            <div>
              <div class="flex flex-wrap items-center gap-2">
                <div class="font-medium">
                  {{ r.get_type_display }}{% if r.what %}<span class="text-gray-500">‚Ä¢ {{ r.what }}</span>{% endif %}
                </div>
                {% if r.type == 'progress' and r.progress_trend %}
                  <span class="text-[11px] tracking-wide uppercase px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700">
                    {{ r.get_progress_trend_display }}
                  </span>
                {% endif %}
                {% if r.is_exception %}
                  <span class="text-[11px] tracking-wide uppercase px-2 py-0.5 rounded-full bg-rose-50 text-rose-700">
                    Exce√ß√£o
                  </span>
                {% endif %}
                {% if r.created_by_id == request.user.id or request.user.is_superuser %}
                  <a href="{% url 'care:record-update' r.pk %}"
                     class="text-xs text-blue-600 hover:underline ml-auto">Editar</a>
                {% endif %}
              </div>
              {% if r.description %}<div class="text-gray-500 text-sm line-clamp-2">{{ r.description }}</div>{% endif %}
              {% if r.author_name %}<div class="text-xs text-gray-400 mt-1">Cuidador: {{ r.author_name }}</div>{% endif %}
            </div>
          </div>
          <div class="text-right shrink-0">
            <div class="text-sm text-gray-700">{{ r.date|date:'d/m' }} {{ r.time|time:'H:i' }}</div>
            {% if r.timestamp %}<div class="text-xs text-gray-400 mt-1">criado {{ r.timestamp|date:'d/m H:i' }}</div>{% endif %}
          </div>
        </li>
      {% endfor %}
    </ol>
    <div class="mt-4 flex items-center justify-between text-sm">
      <div>{% if recent.has_previous %}<a class="underline" href="?page={{ recent.previous_page_number }}">‚Üê Anterior</a>{% endif %}</div>
      <div>p√°gina {{ recent.number }} de {{ recent.paginator.num_pages }}</div>
      <div>{% if recent.has_next %}<a class="underline" href="?page={{ recent.next_page_number }}">Pr√≥xima ‚Üí</a>{% endif %}</div>
    </div>
  {% else %}
    <p class="text-gray-500">Nenhum registro ainda.</p>
  {% endif %}
</div>

<!-- Helpers -->
<script>
  function localISODate(d=new Date()){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
  document.addEventListener('DOMContentLoaded', ()=>{
    const dateEl=document.querySelector('input[type="date"][name="date"]');
    if(dateEl&&!dateEl.value) dateEl.value=localISODate();
    const timeEl=document.querySelector('input[type="time"][name="time"]');
    if(timeEl&&!timeEl.value){const n=new Date();timeEl.value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}
    ['what','description'].forEach(n=>{const el=document.querySelector(`[name="${n}"]`); if(el&&el.placeholder) el.placeholder='';});
    const sleepRadios=document.querySelectorAll('input[name="sleep_event"]'); const whatHidden=document.querySelector('input[name="what"]');
    if(sleepRadios.length&&whatHidden){const cur=(whatHidden.value||'').toLowerCase(); sleepRadios.forEach(r=>{ if(r.value.toLowerCase()===cur) r.checked=true; r.addEventListener('change',()=>{whatHidden.value=r.value;});});
      document.getElementById('record-form')?.addEventListener('submit',()=>{const sel=[...sleepRadios].find(r=>r.checked); if(sel){whatHidden.value=sel.value;}});}

    // Recorr√™ncia ‚Äì mostrar/esconder e validar
    const recSel=document.getElementById('{{ form.recurrence.id_for_label|default:"recurrence" }}')||document.getElementById('recurrence');
    const untilWrap=document.getElementById('repeat-until-wrap');
    const untilEl=document.getElementById('{{ form.repeat_until.id_for_label|default:"repeat_until" }}')||document.getElementById('repeat_until');

    function activeRec(){ if(!recSel) return false; const v=(recSel.value||'none').toLowerCase(); return v!=='none'&&v!==''; }
    function toggleUntil(){ if(untilWrap) untilWrap.classList.toggle('hidden', !activeRec()); }
    function syncMin(){ if(!dateEl||!untilEl) return; const s=dateEl.value||localISODate(); untilEl.min=s; if(untilEl.value && untilEl.value < s) untilEl.value=s; }

    toggleUntil(); syncMin();
    recSel?.addEventListener('change', ()=>{ toggleUntil(); if(activeRec()&&untilEl&&!untilEl.value){ untilEl.value=dateEl?.value||localISODate(); }});
    dateEl?.addEventListener('change', syncMin); dateEl?.addEventListener('input', syncMin);
    document.getElementById('record-form')?.addEventListener('submit', ()=>{ if(activeRec()&&untilEl&&!untilEl.value){ untilEl.value=dateEl?.value||localISODate(); }});

    // Mostrar campo "Outro" para sele√ß√µes √∫nicas
    const OTHER_VALUE = "__other__";
    document.querySelectorAll('[data-other-for]').forEach((wrap) => {
      const field = wrap.getAttribute('data-other-for');
      const inputs = document.querySelectorAll(`input[name="${field}"]`);
      if (!inputs.length) return;
      const toggle = () => {
        const selected = Array.from(inputs).find((i) => i.checked)?.value;
        wrap.classList.toggle('hidden', selected !== OTHER_VALUE);
      };
      inputs.forEach((i) => i.addEventListener('change', toggle));
      toggle();
    });

    // Speech to text + parsing autom√°tico (todas as categorias)
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const voiceBlocks = document.querySelectorAll('[data-voice-block]');
    const descInput = document.querySelector('textarea[name="description"]');
    const whatInput = document.querySelector('[name="what"]');

    const pad2 = (n) => String(n).padStart(2, '0');
    const normalize = (s) => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const compactUnits = (s) => (s || '').replace(/(\d)\s*(mg|ml|mcg)/g, '$1$2');
    const lastIndexOfAny = (text, tokens) => {
      let idx = -1;
      tokens.forEach((t) => {
        const i = text.lastIndexOf(t);
        if (i > idx) idx = i;
      });
      return idx;
    };
    const parseDate = (rawText) => {
      const text = normalize(rawText);
      const today = new Date();
      const addDays = (d, n) => {
        const x = new Date(d);
        x.setDate(x.getDate() + n);
        return x;
      };
      if (text.includes('hoje')) return today;
      if (text.includes('ontem')) return addDays(today, -1);
      if (text.includes('amanha')) return addDays(today, 1);

      const numeric = text.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
      if (numeric) {
        const day = parseInt(numeric[1], 10);
        const month = parseInt(numeric[2], 10);
        let year = numeric[3] ? parseInt(numeric[3], 10) : today.getFullYear();
        if (year < 100) year += 2000;
        const dt = new Date(year, month - 1, day);
        if (dt && dt.getMonth() === month - 1 && dt.getDate() === day) return dt;
      }

      const months = {
        janeiro: 1, fevereiro: 2, marco: 3, abril: 4, maio: 5, junho: 6,
        julho: 7, agosto: 8, setembro: 9, outubro: 10, novembro: 11, dezembro: 12,
      };
      const named = text.match(/(\d{1,2})\s*(?:de\s*)?([a-z√ß√£]+)/);
      if (named) {
        const day = parseInt(named[1], 10);
        const monthName = named[2];
        const month = months[monthName];
        if (month) {
          const dt = new Date(today.getFullYear(), month - 1, day);
          if (dt && dt.getMonth() === month - 1 && dt.getDate() === day) return dt;
        }
      }

      const dayOnly = text.match(/dia\s*(\d{1,2})/);
      if (dayOnly) {
        const day = parseInt(dayOnly[1], 10);
        const dt = new Date(today.getFullYear(), today.getMonth(), day);
        if (dt && dt.getMonth() === today.getMonth() && dt.getDate() === day) return dt;
      }
      return null;
    };
    const parseTime = (rawText) => {
      const text = normalize(rawText);
      if (text.includes('meia noite') || text.includes('meia-noite')) return '00:00';
      if (text.includes('meio dia') || text.includes('meio-dia')) return '12:00';

      const periodMatch = text.match(/\bda\s+(manha|tarde|noite|madrugada)\b/);
      const period = periodMatch ? periodMatch[1] : '';
      const adjustHour = (hour) => {
        let h = hour;
        if (period === 'tarde' || period === 'noite') {
          if (h < 12) h += 12;
        } else if (period === 'manha' || period === 'madrugada') {
          if (h === 12) h = 0;
        }
        return h;
      };

      let match = text.match(/(?:\bas?\s*)?(\d{1,2})\s*e\s*meia\b/);
      if (match) {
        let hour = parseInt(match[1], 10);
        hour = adjustHour(hour);
        if (hour > 23) hour = hour % 24;
        return `${pad2(hour)}:30`;
      }

      match = text.match(/(?:\bas?\s*)?(\d{1,2})\s*[:h]\s*(\d{2})\b/);
      if (!match) match = text.match(/(?:\bas?\s*)?(\d{1,2})\s*h\b/);
      if (!match) match = text.match(/(?:\bas?\s*)?(\d{1,2})\s*horas?\b(?:\s*e\s*(\d{1,2}))?/);
      if (!match) match = text.match(/(?:\bas?\s*)(\d{1,2})\s*e\s*(\d{1,2})/);
      if (!match) return '';

      let hour = parseInt(match[1], 10);
      let minute = match[2] ? parseInt(match[2], 10) : 0;
      if (Number.isNaN(hour) || Number.isNaN(minute)) return '';
      if (hour > 23 || minute > 59) return '';
      hour = adjustHour(hour);
      if (hour > 23) hour = hour % 24;
      return `${pad2(hour)}:${pad2(minute)}`;
    };
    const parseRecurrence = (rawText) => {
      const text = normalize(rawText);
      if (/todo(?:s)?\s*os?\s*dias?|diariamente|toda(?:s)?\s+noite(?:s)?/.test(text)) return 'daily';
      if (/toda(?:s)?\s*semana(?:s)?|semanal/.test(text)) return 'weekly';
      if (/todo(?:s)?\s*mes(?:es)?|mensal/.test(text)) return 'monthly';
      return '';
    };
    const splitMainAndNotes = (rawText) => {
      const match = rawText.match(/\b(?:obs|observa[^\s:]*)\b\s*[:\-]?\s*/i);
      if (!match || typeof match.index !== 'number') {
        return { main: rawText.trim(), notes: '' };
      }
      const idx = match.index;
      const main = rawText.slice(0, idx).trim();
      const notes = rawText.slice(idx + match[0].length).trim();
      return { main, notes };
    };
    const extractExplicitOther = (rawText) => {
      const m = rawText.match(/\b(?:outro|outra|outros|outras)\b\s*[:\-]\s*(.+)$/i);
      return m && m[1] ? m[1].trim() : '';
    };
    const applyNotes = (notes) => {
      if (!notes || !descInput) return;
      if (descInput.value.trim()) {
        if (!descInput.value.includes(notes)) {
          descInput.value = `${descInput.value.trim()}\n${notes}`;
        }
      } else {
        descInput.value = notes;
      }
    };
    const setRadioValue = (name, value) => {
      if (!value) return false;
      const inputs = document.querySelectorAll(`input[name="${name}"]`);
      const target = Array.from(inputs).find((i) => i.value === value);
      if (!target) return false;
      target.checked = true;
      target.dispatchEvent(new Event('change', { bubbles: true }));
      return true;
    };
    const setOtherValue = (name, otherName, text) => {
      if (!text) return false;
      const ok = setRadioValue(name, OTHER_VALUE);
      if (!ok) return false;
      const otherInput = document.querySelector(`[name="${otherName}"]`);
      if (otherInput) {
        otherInput.value = text;
        otherInput.dispatchEvent(new Event('input', { bubbles: true }));
      }
      return true;
    };
    const matchByList = (text, list) => {
      const norm = normalize(text);
      for (const [token, value] of list) {
        if (norm.includes(token)) return value;
      }
      return '';
    };
    const parseQuantity = (rawText) => {
      const text = normalize(rawText);
      const m = text.match(/(\d+)\s*(capsulas?|capsula|gotas?|gota|comprimidos?|comprimido|unidades?)/);
      if (!m) return null;
      const qty = parseInt(m[1], 10);
      return Number.isNaN(qty) ? null : qty;
    };
    const getRadioOptions = (name) => (
      Array.from(document.querySelectorAll(`input[name="${name}"]`)).map((input) => {
        const label = input.closest('label')?.textContent || '';
        return { value: input.value, label: label.trim(), norm: normalize(label) };
      })
    );
    const matchOptionFromTranscript = (options, rawText) => {
      const normText = compactUnits(normalize(rawText));
      const usable = options.filter((o) => o.value !== OTHER_VALUE && o.norm);
      const byFull = usable
        .map((o) => ({ ...o, norm: compactUnits(o.norm) }))
        .filter((o) => normText.includes(o.norm))
        .sort((a, b) => b.norm.length - a.norm.length);
      if (byFull.length) return byFull[0];
      const sorted = usable
        .map((o) => ({ ...o, norm: compactUnits(o.norm) }))
        .sort((a, b) => b.norm.length - a.norm.length);
      for (const opt of sorted) {
        const tokens = opt.norm.split(/\s+/).filter((t) => t.length > 2 && t !== 'mg');
        if (tokens.length && tokens.every((t) => normText.includes(t))) return opt;
      }
      return null;
    };
    const extractMedicationOther = (rawText) => {
      let t = rawText;
      t = t.replace(/\b(remedio|rem√©dio|medicamento|tomou|tomar|usar|usou)\b/gi, ' ');
      t = t.replace(/\b(hoje|ontem|amanha|amanh√£)\b/gi, ' ');
      t = t.replace(/\b\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?\b/g, ' ');
      t = t.replace(/\b\d{1,2}[:h]\d{2}\b/g, ' ');
      t = t.replace(/\b\d{1,2}\s*h\b/g, ' ');
      t = t.replace(/\b\d+\s*(capsulas?|c√°psulas?|capsula|c√°psula|gotas?|gota|comprimidos?|comprimido)\b/gi, ' ');
      t = t.replace(/\b(diario|diariamente|semanal|mensal|toda semana|todos os dias)\b/gi, ' ');
      t = t.replace(/\b(as|√†s|da|de)\b/gi, ' ');
      t = t.replace(/\s{2,}/g, ' ').trim();
      return t;
    };

    const VITAL_KIND_MAP = [
      ['pressao arterial', 'Press√£o arterial (PA)'],
      ['pressao', 'Press√£o arterial (PA)'],
      ['pa', 'Press√£o arterial (PA)'],
      ['frequencia cardiaca', 'Frequ√™ncia card√≠aca (FrC)'],
      ['frequencia', 'Frequ√™ncia card√≠aca (FrC)'],
      ['cardiaca', 'Frequ√™ncia card√≠aca (FrC)'],
      ['fc', 'Frequ√™ncia card√≠aca (FrC)'],
      ['spo2', 'SpO2 (Ox√≠metro)'],
      ['oximetro', 'SpO2 (Ox√≠metro)'],
      ['saturacao', 'SpO2 (Ox√≠metro)'],
      ['temperatura', 'Temperatura'],
      ['termometro', 'Temperatura'],
    ];
    const VITAL_STATUS_MAP = [
      ['baixa saturacao', 'Baixa satura√ß√£o'],
      ['saturacao baixa', 'Baixa satura√ß√£o'],
      ['hipertenso', 'Hipertenso'],
      ['hipotenso', 'Hipotenso'],
      ['taquicardia', 'Taquicardia'],
      ['bradicardia', 'Bradicardia'],
      ['hipotermia', 'Hipotermia'],
      ['febre', 'Febre'],
      ['normal', 'Normal'],
    ];
    const BATHROOM_TYPE_MAP = [
      ['higienizacao oral', 'Higieniza√ß√£o oral'],
      ['higiene oral', 'Higieniza√ß√£o oral'],
      ['escovacao', 'Higieniza√ß√£o oral'],
      ['escovou', 'Higieniza√ß√£o oral'],
      ['escovar os dentes', 'Higieniza√ß√£o oral'],
      ['evacuacao', 'Evacua√ß√£o'],
      ['fezes', 'Evacua√ß√£o'],
      ['coco', 'Evacua√ß√£o'],
      ['urina', 'Urina'],
      ['xixi', 'Urina'],
      ['mijou', 'Urina'],
      ['banho', 'Banho'],
      ['vomito', 'V√¥mito'],
      ['vomitou', 'V√¥mito'],
    ];
    const MEAL_TYPE_MAP = [
      ['cafe da manha', 'Caf√© da manh√£'],
      ['lanche da manha', 'Lanche da manh√£'],
      ['almoco', 'Almo√ßo'],
      ['lanche da tarde', 'Lanche da tarde'],
      ['jantar', 'Jantar'],
      ['ceia', 'Ceia da noite'],
    ];
    const MEAL_BAD_TOKENS = [
      'nao aceitou', 'recusou', 'ruim', 'pouca aceitacao', 'pouco', 'baixa aceitacao', 'comeu pouco',
    ];
    const MEAL_GOOD_TOKENS = [
      'boa aceitacao', 'aceitou bem', 'boa', 'bem', 'aceitou',
    ];
    const PROGRESS_EVOLUTION = ['evolucao', 'evoluiu', 'melhora', 'melhorou', 'progresso'];
    const PROGRESS_REGRESSION = ['regressao', 'regrediu', 'piora', 'piorou', 'regressivo'];
    const SLEEP_DORMIU = ['dormiu', 'dormi', 'dormir', 'adormeceu', 'foi dormir', 'deitou', 'cochilou', 'dormindo'];
    const SLEEP_ACORDOU = ['acordou', 'acordei', 'acordar', 'despertou', 'levantou', 'acordado'];

    const applyCommon = (rawText, statusParts) => {
      const dateObj = parseDate(rawText);
      const timeHM = parseTime(rawText);
      const recurrence = parseRecurrence(rawText);
      const { notes } = splitMainAndNotes(rawText);

      if (dateObj && dateEl) {
        const dateISO = `${dateObj.getFullYear()}-${pad2(dateObj.getMonth() + 1)}-${pad2(dateObj.getDate())}`;
        dateEl.value = dateISO;
        dateEl.dispatchEvent(new Event('change'));
        statusParts.push(`data ${dateISO.split('-').reverse().join('/')}`);
      }
      if (timeHM && timeEl) {
        timeEl.value = timeHM;
        statusParts.push(`hora ${timeHM}`);
      }
      if (recurrence && recSel) {
        recSel.value = recurrence;
        recSel.dispatchEvent(new Event('change'));
        statusParts.push(`recorr√™ncia ${recurrence}`);
      }
      if (notes) applyNotes(notes);
    };

    const applyCategory = (category, rawText, statusParts) => {
      const { main } = splitMainAndNotes(rawText);
      const normalized = normalize(rawText);
      const explicitOther = extractExplicitOther(rawText);

      if (category === 'sleep') {
        const dormiuIdx = lastIndexOfAny(normalized, SLEEP_DORMIU);
        const acordouIdx = lastIndexOfAny(normalized, SLEEP_ACORDOU);
        let event = '';
        if (dormiuIdx >= 0 || acordouIdx >= 0) {
          event = dormiuIdx > acordouIdx ? 'dormiu' : 'acordou';
        }
        if (event) {
          if (setRadioValue('sleep_event', event)) statusParts.push(event);
        } else if (explicitOther) {
          if (setOtherValue('sleep_event', 'sleep_event_other', explicitOther)) {
            statusParts.push('outro sono');
          }
        }
        return;
      }

      if (category === 'vital') {
        const kind = matchByList(rawText, VITAL_KIND_MAP);
        const status = matchByList(rawText, VITAL_STATUS_MAP);
        if (kind) {
          if (setRadioValue('vital_kind', kind)) statusParts.push('tipo vital');
        }
        if (!kind && explicitOther) {
          setOtherValue('vital_kind', 'vital_kind_other', explicitOther);
        }
        if (status) {
          if (setRadioValue('vital_status', status)) statusParts.push('status vital');
        }
        return;
      }

      if (category === 'bathroom') {
        const noOcc = /sem ocorrencia|nenhuma ocorrencia|sem ida/.test(normalized);
        const noOccEl = document.querySelector('input[name="bathroom_no_occurrence"]');
        if (noOcc && noOccEl) {
          noOccEl.checked = true;
          statusParts.push('sem ocorr√™ncia');
          document.querySelectorAll('input[name="bathroom_type"]').forEach((i) => { i.checked = false; });
          return;
        }
        const bType = matchByList(rawText, BATHROOM_TYPE_MAP);
        if (bType) {
          if (setRadioValue('bathroom_type', bType)) statusParts.push('tipo banheiro');
        } else if (explicitOther) {
          setOtherValue('bathroom_type', 'bathroom_type_other', explicitOther);
        }
        return;
      }

      if (category === 'meal') {
        const mealType = matchByList(rawText, MEAL_TYPE_MAP);
        let acceptance = '';
        if (MEAL_BAD_TOKENS.some((t) => normalized.includes(t))) acceptance = 'Ruim aceita√ß√£o';
        else if (MEAL_GOOD_TOKENS.some((t) => normalized.includes(t))) acceptance = 'Boa aceita√ß√£o';

        if (mealType) {
          if (setRadioValue('meal_type', mealType)) statusParts.push('refei√ß√£o');
        }
        if (!mealType && explicitOther) {
          setOtherValue('meal_type', 'meal_type_other', explicitOther);
        }
        if (acceptance) {
          if (setRadioValue('meal_acceptance', acceptance)) statusParts.push('aceita√ß√£o');
        }
        return;
      }

      if (category === 'medication') {
        const qty = parseQuantity(rawText);
        if (qty && document.querySelector('input[name="capsule_quantity"]')) {
          document.querySelector('input[name="capsule_quantity"]').value = qty;
          statusParts.push(`qtd ${qty}`);
        }
        const medOptions = getRadioOptions('medication');
        const matched = matchOptionFromTranscript(medOptions, rawText);
        if (matched) {
          if (setRadioValue('medication', matched.value)) statusParts.push('rem√©dio');
        } else {
          const otherMed = explicitOther || extractMedicationOther(main || rawText);
          if (otherMed) {
            setOtherValue('medication', 'medication_other', otherMed);
            statusParts.push('rem√©dio outro');
          }
        }
        return;
      }

      if (category === 'progress') {
        const evoIdx = lastIndexOfAny(normalized, PROGRESS_EVOLUTION);
        const regIdx = lastIndexOfAny(normalized, PROGRESS_REGRESSION);
        let trend = '';
        if (evoIdx >= 0 || regIdx >= 0) {
          trend = evoIdx > regIdx ? 'evolution' : 'regression';
        }
        if (trend) {
          if (setRadioValue('progress_trend', trend)) statusParts.push('classifica√ß√£o');
        } else if (explicitOther) {
          setOtherValue('progress_trend', 'progress_trend_other', explicitOther);
        }
        return;
      }

      if (category === 'activity' || category === 'other') {
        let text = main || rawText;
        text = text.replace(/\b(atividade|exercicio|exerc√≠cio|outros?|outra)\b/gi, '').trim();
        if (text && whatInput && !whatInput.value) {
          whatInput.value = text;
          statusParts.push('detalhe');
        }
      }
    };

    voiceBlocks.forEach((block) => {
      const voiceBtn = block.querySelector('[data-voice-btn]');
      const voiceApply = block.querySelector('[data-voice-apply]');
      const voiceStatus = block.querySelector('[data-voice-status]');
      const voiceTranscript = block.querySelector('[data-voice-transcript]');
      const category = block.dataset.voiceCategory || '';

      if (!voiceBtn || !voiceTranscript) return;
      if (!SpeechRec) {
        voiceBtn.disabled = true;
        voiceBtn.classList.add('opacity-50', 'cursor-not-allowed');
        if (voiceStatus) voiceStatus.textContent = 'Navegador sem suporte a √°udio.';
        return;
      }

      let recognition = new SpeechRec();
      let listening = false;
      let finalText = '';

      recognition.lang = 'pt-BR';
      recognition.interimResults = true;
      recognition.continuous = false;

      recognition.onstart = () => {
        listening = true;
        finalText = '';
        if (voiceStatus) voiceStatus.textContent = 'Ouvindo...';
        voiceBtn.classList.add('bg-blue-50', 'border-blue-200');
      };
      recognition.onend = () => {
        listening = false;
        voiceBtn.classList.remove('bg-blue-50', 'border-blue-200');
        const text = (voiceTranscript.value || '').trim();
        if (text) {
          const statusParts = [];
          applyCommon(text, statusParts);
          applyCategory(category, text, statusParts);
          if (voiceStatus) {
            voiceStatus.textContent = statusParts.length
              ? `Preenchido: ${statusParts.join(' ‚Ä¢ ')}`
              : 'Transcri√ß√£o aplicada';
          }
        }
      };
      recognition.onerror = (e) => {
        listening = false;
        voiceBtn.classList.remove('bg-blue-50', 'border-blue-200');
        if (voiceStatus) voiceStatus.textContent = `Erro: ${e.error || 'desconhecido'}`;
      };
      recognition.onresult = (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i += 1) {
          const res = e.results[i];
          if (res.isFinal) {
            finalText += `${res[0].transcript} `;
          } else {
            interim += res[0].transcript;
          }
        }
        voiceTranscript.value = `${finalText}${interim}`.trim();
      };

      voiceBtn.addEventListener('click', () => {
        if (listening) {
          recognition.stop();
          return;
        }
        if (voiceStatus) voiceStatus.textContent = '';
        voiceTranscript.value = '';
        try {
          recognition.start();
        } catch (err) {
          if (voiceStatus) voiceStatus.textContent = 'N√£o foi poss√≠vel iniciar.';
        }
      });

      voiceApply?.addEventListener('click', () => {
        const text = (voiceTranscript.value || '').trim();
        if (!text) return;
        const statusParts = [];
        applyCommon(text, statusParts);
        applyCategory(category, text, statusParts);
        if (voiceStatus) {
          voiceStatus.textContent = statusParts.length
            ? `Preenchido: ${statusParts.join(' ‚Ä¢ ')}`
            : 'Transcri√ß√£o aplicada';
        }
      });
    });
  });
</script>
{% endblock %}
