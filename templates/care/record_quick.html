{% extends "base.html" %}
{% load static %}
{% block title %}Novo Registro ‚Ä¢ CuidarJuntos{% endblock %}

{% block content %}
<!-- Grade de categorias -->
<div class="bg-white border rounded-xl p-5 mb-6">
  <h2 class="text-xl font-semibold mb-4">Selecione a Categoria</h2>

  {% url 'care:record-create' as new_url %}
  <ul class="grid grid-cols-2 gap-3 sm:grid-cols-3 sm:gap-4">
    {% for value,label in categories %}
      <li>
        <a href="{{ new_url }}?category={{ value }}"
           class="group block rounded-xl border bg-white focus:outline-none focus:ring-2 focus:ring-blue-300
                  p-3 sm:p-4 h-28 sm:h-32 flex flex-col items-center justify-center select-none touch-manipulation
                  {% if selected_category == value %} ring-2 ring-blue-500 bg-blue-50 border-blue-200 {% else %} hover:shadow-sm {% endif %}">
          <span class="text-3xl sm:text-4xl mb-1">
            {% if value == 'medication' %}üíä{% elif value == 'sleep' %}üåô
            {% elif value == 'meal' %}üçΩÔ∏è{% elif value == 'bathroom' %}üöΩ
            {% elif value == 'activity' %}üèÉ{% elif value == 'vital' %}‚ù§Ô∏è{% else %}‚ûï{% endif %}
          </span>
          <span class="text-sm sm:text-base font-medium text-center leading-tight">{{ label }}</span>
        </a>
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Formul√°rio -->
<div class="bg-white border rounded-xl p-5">
  <h3 class="text-lg font-semibold mb-2">
    Registrar {% for v,l in categories %}{% if v == selected_category %}{{ l }}{% endif %}{% endfor %}
  </h3>

  {% if current_patient %}
    <p class="text-sm text-gray-600 mb-4">Paciente: <strong>{{ current_patient.name }}</strong></p>
  {% endif %}

  {% if form.errors %}
    <div class="mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-red-700 text-sm">
      <strong>Corrija os erros abaixo:</strong>
      {{ form.errors }}
    </div>
  {% endif %}

  <form method="post" class="space-y-4" id="record-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Campos ocultos (travados) -->
    <div class="hidden">
      {{ form.patient }}
      {{ form.type }}
    </div>

    <!-- Data / Hora -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1">Data</label>
        {{ form.date }}
        {{ form.date.errors }}
      </div>
      <div>
        <label class="block text-sm mb-1">Hor√°rio</label>
        {{ form.time }}
        {{ form.time.errors }}
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-xs sm:text-sm mb-1">Recorr√™ncia</label>
        <select name="recurrence" id="recurrence" class="w-full rounded-md border px-3 h-10">
          <option value="none">N√£o se repete</option>
          <option value="daily">Diariamente</option>
          <option value="weekly">Semanalmente</option>
        </select>
      </div>
      <div id="repeat-until-wrap" class="hidden">
        <label class="block text-xs sm:text-sm mb-1">Repetir at√©</label>
        <input type="date" name="repeat_until" id="repeat_until" class="w-full rounded-md border px-3 h-10">
      </div>
    </div>

    <script>
      (function(){
        const sel = document.getElementById('recurrence');
        const wrap = document.getElementById('repeat-until-wrap');
        function toggle(){ wrap.classList.toggle('hidden', sel.value === 'none'); }
        if(sel && wrap){ sel.addEventListener('change', toggle); toggle(); }
      })();
    </script>

    {% if selected_category == 'sleep' %}
      <!-- Sono: radios Dormiu/Acordou -->
      <div class="mt-2">
        <label class="block text-sm mb-2">Status do sono</label>

        {# Se o form possui sleep_event (forms.py atualizado), usa-o #}
        {% if form.sleep_event %}
          {{ form.sleep_event.errors }}
          <ul class="flex gap-3">
            {% for rb in form.sleep_event %}
              <li>
                <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
                  {{ rb.tag }}
                  <span>{{ rb.choice_label|title }}</span>
                </label>
              </li>
            {% endfor %}
          </ul>
          <!-- what provavelmente est√° hidden pelo form; se n√£o, escondemos -->
          <div class="hidden">{{ form.what }}</div>

        {% else %}
          {# Fallback: cria os radios e mant√©m what escondido; JS sincroniza #}
          <div class="flex gap-3">
            <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
              <input type="radio" name="sleep_event" value="Dormiu">
              <span>Dormiu</span>
            </label>
            <label class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer hover:bg-gray-50">
              <input type="radio" name="sleep_event" value="Acordou">
              <span>Acordou</span>
            </label>
          </div>
          <div class="hidden">
            {{ form.what }}
          </div>
          {{ form.what.errors }}
        {% endif %}
      </div>
    {% else %}
      <!-- Outras categorias: campo "O que" normal (sem placeholder) -->
      <div class="mt-2">
        <label class="block text-sm mb-1">
          {% if selected_category == 'medication' %}Medicamento/Dose
            {% elif selected_category == 'meal' %}Refei√ß√£o
            {% elif selected_category == 'sleep' %}Per√≠odo/Qualidade
            {% elif selected_category == 'bathroom' %}Tipo (Urina/Evacua√ß√£o)
            {% elif selected_category == 'activity' %}Atividade
            {% elif selected_category == 'vital' %}Sinal (PA, glicemia, temperatura‚Ä¶)
            {% else %}Tipo / Detalhe
            {% endif %}
        </label>
        {{ form.what }}
        {{ form.what.errors }}
      </div>
    {% endif %}

    <!-- Observa√ß√µes -->
    <div>
      <label class="block text-sm mb-1">Observa√ß√µes</label>
      {{ form.description }}
      {{ form.description.errors }}
    </div>

    <button class="w-full bg-blue-600 text-white rounded-lg py-3 font-medium hover:bg-blue-700">
      Registrar Atividade
    </button>
  </form>
</div>

<div id="history" class="bg-white border rounded-xl p-5 mt-6">
  <h2 class="text-xl font-semibold mb-4">Hist√≥rico recente</h2>

  {% if recent and recent.paginator.count %}
    <ol class="divide-y">
      {% for r in recent %}
        <li class="py-3 flex items-start justify-between gap-6">
          <!-- ESQUERDA: √≠cone + conte√∫do + Editar -->
          <div class="flex items-start gap-3">
            <span class="text-2xl">
              {% if r.type == 'medication' %}üíä{% elif r.type == 'sleep' %}üåô
              {% elif r.type == 'meal' %}üçΩÔ∏è{% elif r.type == 'bathroom' %}üöΩ
              {% elif r.type == 'activity' %}üèÉ{% elif r.type == 'vital' %}‚ù§Ô∏è{% else %}üìù{% endif %}
            </span>
            <div>
              <div class="flex items-center gap-3">
                <div class="font-medium">
                  {{ r.get_type_display }}
                  {% if r.what %}<span class="text-gray-500">‚Ä¢ {{ r.what }}</span>{% endif %}
                </div>
                <!-- Editar SEM restri√ß√£o, √† esquerda -->
                {% if r.created_by_id == request.user.id or request.user.is_superuser %}
                  <a href="{% url 'care:record-update' r.pk %}" class="text-xs text-blue-600 hover:underline">Editar</a>
                {% endif %}
              </div>

              {% if r.description %}
                <div class="text-gray-500 text-sm line-clamp-2">{{ r.description }}</div>
              {% endif %}

              {% if r.caregiver %}
                <div class="text-xs text-gray-400 mt-1">Cuidador: {{ r.caregiver }}</div>
              {% endif %}
            </div>
          </div>

          <!-- DIREITA: data/hora + criado -->
          <div class="text-right shrink-0">
            <div class="text-sm text-gray-700">
              {{ r.date|date:'d/m' }} {{ r.time|time:'H:i' }}
            </div>
            {% if r.timestamp %}
              <div class="text-xs text-gray-400 mt-1">
                criado {{ r.timestamp|date:'d/m H:i' }}
              </div>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ol>

    <div class="mt-4 flex items-center justify-between text-sm">
      <div>
        {% if recent.has_previous %}
          <a class="underline" href="?page={{ recent.previous_page_number }}">‚Üê Anterior</a>
        {% endif %}
      </div>
      <div>p√°gina {{ recent.number }} de {{ recent.paginator.num_pages }}</div>
      <div>
        {% if recent.has_next %}
          <a class="underline" href="?page={{ recent.next_page_number }}">Pr√≥xima ‚Üí</a>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p class="text-gray-500">Nenhum registro ainda.</p>
  {% endif %}
</div>


<!-- Helpers: preencher data/hora se vazios, remover placeholders e sincronizar sono -->
<script>
  // Gera YYYY-MM-DD no fuso LOCAL (sem UTC)
  function localISODate(d = new Date()) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Data default (s√≥ se o campo estiver vazio)
    const dateEl = document.querySelector('input[type="date"][name="date"]');
    if (dateEl && !dateEl.value) {
      dateEl.value = localISODate();   // ‚úÖ agora no hor√°rio local
    }

    // Hora default (j√° era local, mantemos)
    const timeEl = document.querySelector('input[type="time"][name="time"]');
    if (timeEl && !timeEl.value) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      timeEl.value = `${hh}:${mm}`;
    }

    // Remover placeholders e sincronizar ‚Äúsono‚Äù (mant√©m seu c√≥digo)
    ['what','description'].forEach(name => {
      const el = document.querySelector(`[name="${name}"]`);
      if (el && el.placeholder) el.placeholder = '';
    });
    const sleepRadios = document.querySelectorAll('input[name="sleep_event"]');
    const whatHidden  = document.querySelector('input[name="what"]');
    if (sleepRadios.length && whatHidden) {
      const current = (whatHidden.value || '').toLowerCase();
      sleepRadios.forEach(r => {
        if (r.value.toLowerCase() === current) r.checked = true;
        r.addEventListener('change', () => { whatHidden.value = r.value; });
      });
      const form = document.getElementById('record-form');
      if (form) form.addEventListener('submit', () => {
        const sel = Array.from(sleepRadios).find(r => r.checked);
        if (sel) { whatHidden.value = sel.value; }
      });
    }
  });
</script>
{% endblock %}
