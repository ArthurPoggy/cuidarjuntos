{% extends "base.html" %}
{% load static %}
{% block title %}Novo Registro ‚Ä¢ CuidarJuntos{% endblock %}

{% block content %}
<!-- Grade de categorias -->
<div class="bg-white border rounded-xl p-5 mb-6">
  <h2 class="text-xl font-semibold mb-4">Selecione a Categoria</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for value,label in categories %}
      <a href="{% url 'care:record-create' %}?category={{ value }}"
         class="rounded-xl border p-6 text-center transition
                {% if selected_category == value %} ring-2 ring-blue-500 bg-blue-50 border-blue-200 {% else %} hover:bg-gray-50 {% endif %}">
        <div class="text-3xl mb-2">
          {% if value == 'medication' %}üíä{% elif value == 'sleep' %}üåô
          {% elif value == 'meal' %}üçΩÔ∏è{% elif value == 'bathroom' %}üöΩ
          {% elif value == 'activity' %}üèÉ{% else %}‚ûï{% endif %}
        </div>
        <div class="font-medium">{{ label }}</div>
      </a>
    {% endfor %}
  </div>
</div>

<!-- Formul√°rio -->
<div class="bg-white border rounded-xl p-5">
  <h3 class="text-lg font-semibold mb-4">
    Registrar {% for v,l in categories %}{% if v == selected_category %}{{ l }}{% endif %}{% endfor %}
  </h3>

  {% if current_patient %}
    <p class="text-sm text-gray-600 mb-4">Paciente: <strong>{{ current_patient.name }}</strong></p>
  {% endif %}

  {% if form.errors %}
    <div class="mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-red-700 text-sm">
      <strong>Corrija os erros abaixo:</strong>
      {{ form.errors }}
    </div>
  {% endif %}

  <form method="post" class="space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="hidden">
      {{ form.patient }}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1">Data</label>
        {{ form.date }}
        {{ form.date.errors }}
      </div>
      <div>
        <label class="block text-sm mb-1">Hor√°rio</label>
        {{ form.time }}
        {{ form.time.errors }}
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1">Categoria</label>
        {{ form.type }}
        {{ form.type.errors }}
      </div>
      <div>
        <label class="block text-sm mb-1">
          {% if selected_category == 'medication' %}Medicamento/Dose
          {% elif selected_category == 'meal' %}Refei√ß√£o
          {% elif selected_category == 'sleep' %}Per√≠odo/Qualidade
          {% elif selected_category == 'bathroom' %}Tipo (Urina/Evacua√ß√£o)
          {% elif selected_category == 'activity' %}Atividade
          {% else %}Tipo / Detalhe
          {% endif %}
        </label>
        {{ form.what }}
        {{ form.what.errors }}
      </div>
    </div>

    <div>
      <label class="block text-sm mb-1">Observa√ß√µes</label>
      {{ form.description }}
      {{ form.description.errors }}
    </div>

    <button class="w-full bg-blue-600 text-white rounded-lg py-3 font-medium hover:bg-blue-700">
      Registrar Atividade
    </button>
  </form>
</div>

<!-- Fallback: se data/hor√°rio vierem vazios, preencher com agora -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dateEl = document.querySelector('input[type="date"][name="date"]');
    if (dateEl && !dateEl.value) {
      // YYYY-MM-DD para input date (browser mostra dd/mm/aaaa em pt-BR)
      dateEl.value = new Date().toISOString().slice(0, 10);
    }
    const timeEl = document.querySelector('input[type="time"][name="time"]');
    if (timeEl && !timeEl.value) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      timeEl.value = `${hh}:${mm}`;
    }
  });
</script>
{% endblock %}
